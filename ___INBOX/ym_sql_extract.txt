*--------------------------------------------------------------------*
*Extractor 1.0.0 - Por Norman Tinco
*05.11.2016
*--------------------------------------------------------------------*
PROGRAM programa_extractor.

TABLES: tmscsys, t000.
TYPE-POOLS: abap.

CONSTANTS: direccion_codesql  TYPE string VALUE 'D:/code_sql',
           archivo_listadosap TYPE string VALUE 'D:/ntinco/Abap/Bitacora/Tools/listado de sap para mysql.txt',
           direccion_filtro   TYPE string VALUE 'D:/Desktop/extractor/filtro.txt',

           extension_txt      TYPE string VALUE '.txt',
           extension_sql      TYPE string VALUE '.sql',
           extension_cmd      TYPE string VALUE '.cmd',

           gc_slash_unix      TYPE c      VALUE '/',
           gc_guion           TYPE c      VALUE '-',
           gc_comma           TYPE c      VALUE ',',
           gc_underline       TYPE c      VALUE '_'.

TYPES: BEGIN OF gty_empresa,
         licencia TYPE char10,
         empresa  TYPE string,
       END OF gty_empresa,

       BEGIN OF gty_filtro,
         "Crecerá según necesidad
         "SD
         vbeln TYPE vbak-vbeln,

       END OF gty_filtro.

TYPES: tab_tadir  TYPE TABLE OF tadir,
       tab_string TYPE TABLE OF string WITH NON-UNIQUE DEFAULT KEY,
       tab_filtro TYPE TABLE OF gty_filtro WITH NON-UNIQUE DEFAULT KEY.

DATA: vbak   TYPE TABLE OF vbak,
      vbap   TYPE TABLE OF vbap,
      vbfa   TYPE TABLE OF vbfa,
      vbrk   TYPE TABLE OF vbrk,
      vbrp   TYPE TABLE OF vbrp,
      awkey  TYPE TABLE OF bkpf,
      bkpf   TYPE TABLE OF bkpf,
      bseg   TYPE TABLE OF bseg,
      bsad   TYPE TABLE OF bsad,
      bsad1  TYPE TABLE OF bsad,
      bsad2  TYPE TABLE OF bsad,
      bsid   TYPE TABLE OF bsid,
      vbrks  TYPE vbrk,
      awkeys TYPE bkpf.

data: t001   TYPE TABLE OF t001.


include ZOSMM_INC_KARDEX_NEW_GRALTOP.

form n.
  perform main.
endform.

*--------------------------------------------------------------------*
FORM main.

  DATA: ls_empresa TYPE gty_empresa.
  DATA: l_eleccion TYPE string.


  IF sy-host EQ 'DEV'.
    DELETE REPORT: 'YD', 'YF', 'YO', 'YR', 'YT', 'YAF', 'YAR', 'YAT'.
  ENDIF.


  PERFORM obtenerempresa CHANGING ls_empresa.


  PERFORM ingresaropcion_ventana CHANGING l_eleccion.


  PERFORM crearconsultassql_eleccion USING direccion_codesql l_eleccion ls_empresa-empresa.

ENDFORM.


*--------------------------------------------------------------------*
FORM ingresaropcion_ventana CHANGING e_eleccion TYPE clike.

  DATA: lt_field LIKE sval OCCURS 0,
        ls_field LIKE LINE OF lt_field.


  "Ingresar opcion
  ls_field-tabname   = 'TRDIR'.
  ls_field-fieldname = 'NAME'.
  APPEND ls_field TO lt_field.


  CALL FUNCTION 'POPUP_GET_VALUES'
    EXPORTING
      popup_title     = 'Ingrese eleccion'
    TABLES
      fields          = lt_field
    EXCEPTIONS
      error_in_fields = 1
      OTHERS          = 2.


  LOOP AT lt_field INTO ls_field.
    CASE ls_field-fieldname.
      WHEN 'NAME'.  e_eleccion = ls_field-value.
    ENDCASE.
  ENDLOOP.


  "Limpiar huella memory se37
  SET PARAMETER ID 'LIB' FIELD space.

  TRANSLATE e_eleccion TO UPPER CASE.

ENDFORM.


*--------------------------------------------------------------------*
FORM crearconsultassql_eleccion USING i_ruta      TYPE clike
                                          i_eleccion  TYPE clike
                                          i_empresa   TYPE clike.

  DATA: sql            TYPE tab_string,
        where_dinamico TYPE tab_string,
        l_database     TYPE string.

  BREAK-POINT.
  PERFORM llenar_seleccion_eleccion USING i_ruta i_empresa i_eleccion CHANGING where_dinamico.

  CASE i_eleccion.
    WHEN 'DB'. PERFORM flujo_db USING archivo_listadosap  i_ruta i_eleccion i_empresa extension_sql CHANGING sql.
               l_database = 'sakila'.
    when 'RPT'. PERFORM flujo_rpt USING archivo_listadosap  i_ruta i_eleccion i_empresa extension_sql CHANGING sql.
               l_database = 'sakila'.
    WHEN 'SD'. PERFORM flujo_sd USING where_dinamico i_ruta i_eleccion i_empresa extension_txt CHANGING sql.
    WHEN 'MM'. PERFORM flujo_mm USING where_dinamico i_ruta i_eleccion i_empresa extension_txt CHANGING sql.
    WHEN 'FI'. PERFORM flujo_fi USING where_dinamico i_ruta i_eleccion i_empresa extension_txt CHANGING sql.
    WHEN 'CO'. PERFORM flujo_co USING where_dinamico i_ruta i_eleccion i_empresa extension_txt CHANGING sql.
    WHEN 'PP'. PERFORM flujo_pp USING where_dinamico i_ruta i_eleccion i_empresa extension_txt CHANGING sql.
    WHEN 'PM'. PERFORM flujo_pp USING where_dinamico i_ruta i_eleccion i_empresa extension_txt CHANGING sql.
    WHEN 'DEV'. PERFORM flujo_dev USING where_dinamico i_ruta i_eleccion i_empresa extension_txt CHANGING sql.
  ENDCASE.


  SELECT SINGLE * FROM t000 WHERE mandt = sy-mandt.
  CONCATENATE i_empresa '_' t000-logsys(3) INTO l_database.
  PERFORM bajardata_sql USING i_ruta i_empresa i_eleccion i_eleccion sql l_database.

ENDFORM.


*--------------------------------------------------------------------*
FORM llenar_seleccion_eleccion USING i_ruta     TYPE clike
                                     i_empresa  TYPE clike
                                     i_eleccion TYPE clike
                               CHANGING where TYPE tab_string.

  DATA: lt_filtro TYPE TABLE OF string.

  DATA: l_archivofiltro TYPE string,
        l_where         TYPE string.


  PERFORM _subirtxt_tabla USING direccion_filtro abap_on CHANGING lt_filtro.

  LOOP AT lt_filtro INTO l_where.
    CHECK l_where NS '"'.
    CHECK l_where NS '*'.
    CHECK l_where IS NOT INITIAL.
    APPEND l_where TO where.
  ENDLOOP.

ENDFORM.

*--------------------------------------------------------------------*
FORM flujo_db USING i_listado_tablas  TYPE clike
                    i_ruta            TYPE clike
                    i_empresa         TYPE clike
                    i_archivo         TYPE clike
                    i_extension       TYPE clike
              CHANGING sql            TYPE tab_string.


  TYPES: BEGIN OF ty_tab,
           name TYPE dd02l-tabname,
         END OF ty_tab.

  DATA: lt_tab      TYPE TABLE OF ty_tab,
        l_database  TYPE char40,
        l_sql       TYPE string,
        lt_dd02t    TYPE TABLE OF dd02t,
        ls_dd02t    LIKE LINE OF lt_dd02t,
        l_dir_query TYPE string.


  "Listado de tablas
  PERFORM _subirtxt_tabla USING i_listado_tablas abap_on CHANGING lt_tab.


  "Base de datos
  SELECT SINGLE * FROM t000 WHERE mandt = sy-mandt.
  CONCATENATE i_empresa '_' t000-logsys(3) INTO l_database.
  CONCATENATE 'create database' l_database';' INTO l_sql SEPARATED BY space.  APPEND l_sql TO sql.
  CONCATENATE 'use' l_database ';' INTO l_sql SEPARATED BY space.             APPEND l_sql TO sql.


  "Tablas
  SELECT * INTO TABLE lt_dd02t FROM dd02t FOR ALL ENTRIES IN lt_tab
   WHERE tabname = lt_tab-name AND ddlanguage = sy-langu.

  LOOP AT lt_dd02t INTO ls_dd02t.

    "Elaborar cada campo de la tablas en mysql
    PERFORM crearbasedatos_mysql USING ls_dd02t-tabname CHANGING sql.

    "Cierra creacion de tabla
    APPEND ')' TO sql.

    "Descripcion de tabla sap
    APPEND 'engine = innodb' TO sql.
    CONCATENATE 'comment =' '''' ls_dd02t-ddtext ''';' INTO l_sql SEPARATED BY space.
    APPEND l_sql TO sql.
  ENDLOOP.

ENDFORM.

*--------------------------------------------------------------------*
FORM flujo_rpt USING i_listado_tablas  TYPE clike
                    i_ruta            TYPE clike
                    i_empresa         TYPE clike
                    i_archivo         TYPE clike
                    i_extension       TYPE clike
              CHANGING sql            TYPE tab_string.


  TYPES: BEGIN OF ty_tab,
           name TYPE dd02l-tabname,
         END OF ty_tab.

  DATA: lt_tab      TYPE TABLE OF ty_tab,
        l_database  TYPE char40,
        l_sql       TYPE string,
        lt_dd02t    TYPE TABLE OF dd02t,
        ls_dd02t    LIKE LINE OF lt_dd02t,
        l_dir_query TYPE string.


  "Base de datos
  SELECT SINGLE * FROM t000 WHERE mandt = sy-mandt.
  CONCATENATE i_empresa '_' t000-logsys(3) INTO l_database.
  CONCATENATE 'use' l_database ';' INTO l_sql SEPARATED BY space.             APPEND l_sql TO sql.


  "Tabla
DATA: lo_ls   TYPE REF TO cl_abap_structdescr,
      lt_comp TYPE abap_compdescr_tab,
      ls_comp LIKE LINE OF lt_comp.
 
*lo_ls ?= cl_abap_typedescr=>describe_by_name( 'PA0001' ).        "1ra forma
*lo_ls ?= cl_abap_structdescr=>describe_by_data( ls_reporte ).    "2ra forma
lo_ls ?= cl_abap_structdescr=>describe_by_name( 'TY_DETALLE' ).    "3ra forma
lt_comp = lo_ls->components.
break-point.
*LOOP AT lt_comp INTO ls_comp.
*  WRITE:/ ls_comp-name.
*ENDLOOP. 


  "Cierra creacion de tabla
  APPEND ')' TO sql.

  "Descripcion de tabla sap
  APPEND 'engine = innodb' TO sql.
  CONCATENATE 'comment =' '''' 'kardex' ''';' INTO l_sql SEPARATED BY space.
  APPEND l_sql TO sql.

ENDFORM.

*--------------------------------------------------------------------*
FORM flujo_sd USING where_dinamico TYPE tab_string
                    i_dir   TYPE clike
                    i_empr  TYPE clike
                    i_car   TYPE clike
                    i_ext   TYPE clike
              CHANGING sql  TYPE tab_string.

  SELECT * INTO TABLE vbak FROM vbak WHERE (where_dinamico).

  SELECT * INTO TABLE vbap FROM vbap FOR ALL ENTRIES IN vbak WHERE vbeln = vbak-vbeln.
  PERFORM bajardata_manager USING i_dir i_empr i_car 'VBAP' i_ext CHANGING vbap sql.

  SELECT * INTO TABLE vbfa FROM vbfa FOR ALL ENTRIES IN vbak WHERE vbeln = vbak-vbeln.
  PERFORM bajardata_manager USING i_dir i_empr i_car 'VBFA' i_ext CHANGING vbfa sql.

  SELECT * INTO TABLE vbrp FROM vbrp FOR ALL ENTRIES IN vbak WHERE aubel = vbak-vbeln.
  PERFORM bajardata_manager USING i_dir i_empr i_car 'VBAK' i_ext CHANGING vbak sql.

  SELECT * INTO TABLE vbrk FROM vbrk FOR ALL ENTRIES IN vbrp WHERE vbeln = vbrp-vbeln.
  PERFORM bajardata_manager USING i_dir i_empr i_car 'VBRP' i_ext CHANGING vbrp sql.

  LOOP AT vbrk INTO vbrks. awkeys-awkey = vbrks-vbeln. APPEND awkeys TO awkey. ENDLOOP.
  PERFORM bajardata_manager USING i_dir i_empr i_car 'VBRK' i_ext CHANGING vbrk sql.

  SELECT * INTO TABLE bkpf FROM bkpf FOR ALL ENTRIES IN awkey WHERE awtyp = 'VBRK' AND awkey = awkey-awkey. FREE awkey.

  SELECT * INTO TABLE bsad1 FROM bsad FOR ALL ENTRIES IN bkpf  WHERE bukrs = bkpf-bukrs AND belnr = bkpf-belnr AND gjahr = bkpf-gjahr.
  SELECT * INTO TABLE bsad2 FROM bsad FOR ALL ENTRIES IN bsad1 WHERE bukrs = bsad1-bukrs AND belnr = bsad1-augbl AND gjahr = bsad1-gjahr.
  APPEND LINES OF bsad1 TO bsad.
  APPEND LINES OF bsad2 TO bsad.

  SELECT * INTO TABLE bseg FROM bseg FOR ALL ENTRIES IN bsad WHERE bukrs = bsad-bukrs AND belnr = bsad-belnr AND gjahr = bsad-gjahr.

  PERFORM bajardata_manager USING i_dir i_empr i_car 'BKPF' i_ext CHANGING bkpf sql.
  PERFORM bajardata_manager USING i_dir i_empr i_car 'BSAD' i_ext CHANGING bsad sql.
  PERFORM bajardata_manager USING i_dir i_empr i_car 'BSEG' i_ext CHANGING bseg sql.


ENDFORM.

*--------------------------------------------------------------------*
FORM flujo_mm USING where_dinamico TYPE tab_string
                    i_dir   TYPE clike
                    i_empr  TYPE clike
                    i_car   TYPE clike
                    i_ext   TYPE clike
              CHANGING sql TYPE tab_string.

ENDFORM.

*--------------------------------------------------------------------*
FORM flujo_fi USING where_dinamico TYPE tab_string
                    i_dir   TYPE clike
                    i_empr  TYPE clike
                    i_car   TYPE clike
                    i_ext   TYPE clike
              CHANGING sql TYPE tab_string.

ENDFORM.

*--------------------------------------------------------------------*
FORM flujo_co USING where_dinamico TYPE tab_string
                    i_dir   TYPE clike
                    i_empr  TYPE clike
                    i_car   TYPE clike
                    i_ext   TYPE clike
              CHANGING sql TYPE tab_string.

ENDFORM.

*--------------------------------------------------------------------*
FORM flujo_pp USING where_dinamico TYPE tab_string
                    i_dir   TYPE clike
                    i_empr  TYPE clike
                    i_car   TYPE clike
                    i_ext   TYPE clike
              CHANGING sql  TYPE tab_string.

ENDFORM.

*--------------------------------------------------------------------*
FORM flujo_pm USING where_dinamico TYPE tab_string
                    i_dir   TYPE clike
                    i_empr  TYPE clike
                    i_car   TYPE clike
                    i_ext   TYPE clike
              CHANGING sql  TYPE tab_string.

ENDFORM.

*--------------------------------------------------------------------*
FORM flujo_dev USING where_dinamico TYPE tab_string
                    i_dir   TYPE clike
                    i_car   TYPE clike
                    i_empr  TYPE clike
                    i_ext   TYPE clike
              CHANGING sql  TYPE tab_string.

  SELECT * INTO TABLE t001 FROM t001 WHERE (where_dinamico).
  PERFORM bajardata_manager USING i_dir i_empr i_car 'T001' i_ext CHANGING t001 sql.

ENDFORM.

*--------------------------------------------------------------------*
FORM crearbasedatos_mysql USING i_name TYPE clike
                          CHANGING ct_sql TYPE db2_t_string.

  DATA: l_sql    TYPE string.
  DATA: lt_dd03l TYPE TABLE OF dd03l,
        lt_dd04t TYPE TABLE OF dd04t.

  DATA: ls_dd03l    LIKE LINE OF lt_dd03l,
        ls_dd04t    LIKE LINE OF lt_dd04t,
        l_ultimokey TYPE string.


  "Campos de tabla y descripcion
  SELECT * INTO TABLE lt_dd03l FROM dd03l WHERE tabname = i_name.
  SORT lt_dd03l BY tabname position.

  SELECT * INTO TABLE lt_dd04t FROM dd04t FOR ALL ENTRIES IN lt_dd03l WHERE rollname = lt_dd03l-rollname AND ddlanguage = sy-langu.

  "Create table
  CONCATENATE 'CREATE TABLE IF NOT EXISTS `' i_name '` (' INTO l_sql.
  APPEND l_sql TO ct_sql.


  "Tabla
  LOOP AT lt_dd03l INTO ls_dd03l WHERE rollname IS NOT INITIAL.

    READ TABLE lt_dd04t INTO ls_dd04t WITH KEY rollname = ls_dd03l-rollname.

    "Campo by campo
    CONCATENATE '`' ls_dd03l-fieldname '`' INTO l_sql.

    PERFORM crearcampo_mysql USING ls_dd03l ls_dd04t-ddtext CHANGING l_sql.

    APPEND l_sql TO ct_sql.
  ENDLOOP.


  "Inicia campo key
  DELETE lt_dd03l WHERE keyflag IS INITIAL.

  l_sql = 'primary key ('.

  LOOP AT lt_dd03l INTO ls_dd03l WHERE keyflag IS NOT INITIAL.

    CONCATENATE l_sql '`' ls_dd03l-fieldname '`' INTO l_sql.

    AT LAST.
      l_ultimokey = abap_on.
    ENDAT.

    IF l_ultimokey IS INITIAL.
      CONCATENATE l_sql ',' INTO l_sql.
    ENDIF.
  ENDLOOP.

  "Cierra campo key
  CONCATENATE l_sql ')' INTO l_sql.
  APPEND l_sql TO ct_sql.

ENDFORM.


*--------------------------------------------------------------------*
FORM crearcampo_mysql USING ls_dd03l TYPE dd03l
                            i_descripcioncampo TYPE clike
                      CHANGING c_sql TYPE string.

  DATA: l_int         TYPE i,
        l_tamanocampo TYPE char03,
        l_decimales   TYPE char03,
        l_tipocampo   TYPE string.


  "Determina tipo de campo
  CASE ls_dd03l-inttype.
    WHEN 'P'.
      l_tamanocampo = l_int = ls_dd03l-leng.
      l_decimales   = l_int = ls_dd03l-decimals.
      CONDENSE: l_tamanocampo, l_decimales.
      CONCATENATE 'decimal(' l_tamanocampo ',' l_decimales ')' INTO l_tipocampo.
      CONCATENATE c_sql l_tipocampo INTO c_sql SEPARATED BY space.

    WHEN OTHERS.
      l_tamanocampo = l_int = ls_dd03l-leng.
      CONDENSE l_tamanocampo.
      CONCATENATE 'char   (' l_tamanocampo ')'           INTO l_tipocampo.
      CONCATENATE c_sql l_tipocampo INTO c_sql SEPARATED BY space.
      CONCATENATE c_sql 'CHARSET utf8 COLLATE utf8_spanish_ci' INTO c_sql SEPARATED BY space.
  ENDCASE.

  "Si es campo clave
  IF ls_dd03l-keyflag = abap_on.
    CONCATENATE c_sql 'not' INTO c_sql SEPARATED BY space.
  ENDIF.

  "Puede ir vacio
  CONCATENATE c_sql 'null' INTO c_sql SEPARATED BY space.

  "Descripcion del campo
  CONCATENATE c_sql 'comment' '''' i_descripcioncampo '''' gc_comma INTO c_sql SEPARATED BY space.

ENDFORM.

*--------------------------------------------------------------------*
FORM bajardata_sql  USING i_ruta      TYPE clike
                              i_empresa   TYPE clike
                              i_carpeta   TYPE clike
                              i_archivo   TYPE clike
                              sql         TYPE tab_string
                              i_database  TYPE clike.

  DATA: l_dir TYPE string.


  "Archivo con comandos SQL
  PERFORM _crearnombrearchivocompleto USING i_ruta
                                            i_empresa
                                            i_carpeta
                                            i_archivo
                                            extension_sql
                                      CHANGING l_dir.
  PERFORM _bajartabla_txt USING l_dir sql.


  PERFORM runcodigosql_cmd USING i_ruta i_empresa i_carpeta i_archivo l_dir i_database.

ENDFORM.

*--------------------------------------------------------------------*
FORM runcodigosql_cmd USING i_ruta      TYPE clike
                            i_empresa   TYPE clike
                            i_carpeta   TYPE clike
                            i_archivo   TYPE clike
                            i_dir_query TYPE clike
                            i_database  TYPE clike.

  DATA: cmd   TYPE tab_string,
        l_sql TYPE string,
        l_dir TYPE string.


  "Archivo con comandos CMD
  CONCATENATE 'mysql -h localhost -u root -p'
              i_database '<' i_dir_query
              INTO l_sql SEPARATED BY space.
  APPEND l_sql TO cmd.
  APPEND 'pause;' TO cmd.

  PERFORM _crearnombrearchivocompleto USING i_ruta
                                            i_empresa
                                            i_carpeta
                                            i_archivo
                                            extension_cmd
                                      CHANGING l_dir.

  PERFORM _bajartabla_txt USING l_dir cmd.

  cl_gui_frontend_services=>execute( document = l_dir ).

ENDFORM.

*--------------------------------------------------------------------*
FORM bajardata_manager USING i_ruta         TYPE clike
                                 i_empresa      TYPE clike
                                 i_carpeta      TYPE clike
                                 i_nombretabla  TYPE clike
                                 i_extension    TYPE clike
                        CHANGING ct_tabla       TYPE STANDARD TABLE
                                 et_query       TYPE tab_string.

  DATA: l_destino TYPE string,
        l_query   TYPE string,
        l_importe TYPE char30.

  DATA: ld_line TYPE REF TO data.
  DATA: dd03l   TYPE TABLE OF dd03l WITH HEADER LINE.

  DATA: lt_query TYPE TABLE OF string.

  FIELD-SYMBOLS: <fs_line> TYPE any,
                 <fs>      TYPE any.


  CHECK ct_tabla IS NOT INITIAL.


  SELECT * INTO TABLE dd03l FROM dd03l WHERE tabname = i_nombretabla.
  SORT dd03l BY tabname position.

  CREATE DATA ld_line LIKE LINE OF ct_tabla.
  ASSIGN ld_line->* TO <fs_line>.


  LOOP AT ct_tabla ASSIGNING <fs_line>.

    "Line by line
    LOOP AT dd03l.
      ASSIGN COMPONENT dd03l-fieldname OF STRUCTURE <fs_line> TO <fs>.
      IF sy-subrc = 0 AND <fs> IS ASSIGNED.

        "Usar menos espacio mysql
        IF <fs> IS INITIAL OR dd03l-inttype = 'F'.

          CONCATENATE l_query cl_abap_char_utilities=>horizontal_tab INTO l_query.

          "Importe y Cantidad
        ELSEIF dd03l-inttype = 'P'.

          WRITE <fs> TO l_importe.
          IF <fs> < 0.
            SHIFT l_importe RIGHT CIRCULAR.
          ENDIF.
          CONDENSE l_importe.
          CONCATENATE l_query l_importe INTO l_query SEPARATED BY cl_abap_char_utilities=>horizontal_tab.

        ELSEIF l_query IS NOT INITIAL.
          CONCATENATE l_query <fs> INTO l_query SEPARATED BY cl_abap_char_utilities=>horizontal_tab.

          "Mandt
        ELSEIF l_query IS INITIAL.
          l_query = <fs>.
        ENDIF.
      ENDIF.
    ENDLOOP.

    APPEND l_query TO lt_query.
    CLEAR l_query.
  ENDLOOP.


  PERFORM _crearnombrearchivocompleto USING i_ruta
                                            i_empresa
                                            i_carpeta
                                            i_nombretabla
                                            i_extension
                                      CHANGING l_destino.
  PERFORM _bajartabla_txt USING l_destino lt_query.
  FREE ct_tabla.


  "Añadir query mysql
  CONCATENATE '''' l_destino '''' INTO l_destino.
  CONCATENATE 'load data low_priority local infile' l_destino 'replace into table' i_nombretabla ';' INTO l_query SEPARATED BY space.
  APPEND l_query TO et_query.

ENDFORM.


*--------------------------------------------------------------------*
FORM _obtenerconfirmacion USING i_question TYPE clike.

  DATA: l_answer TYPE char01.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'Confirma pe'
      text_question         = i_question
      display_cancel_button = space
    IMPORTING
      answer                = l_answer.

  IF l_answer <> '1'.
    MESSAGE s000(26) WITH 'Acción cancelada...' DISPLAY LIKE 'E'.
    sy-subrc = 1.
  ENDIF.

ENDFORM.


*--------------------------------------------------------------------*
FORM _subirtxt_tabla USING i_ruta       TYPE string
                           i_separator  TYPE c
                     CHANGING et_data   TYPE STANDARD TABLE.

  cl_gui_frontend_services=>gui_upload(
      EXPORTING
        filename            = i_ruta
        has_field_separator = i_separator
        codepage            = '4110'            "utf8
      CHANGING
        data_tab            = et_data ).

ENDFORM.


*--------------------------------------------------------------------*
FORM _bajartabla_txt USING i_ruta   TYPE string
                               it_data  TYPE STANDARD TABLE.

  cl_gui_frontend_services=>gui_download(
      EXPORTING
        filename              = i_ruta
        write_field_separator = abap_on
        codepage              = '4110'           "utf8
*        dat_mode             = abap_on          "formatos numericos
      CHANGING
        data_tab              = it_data
    ).
ENDFORM.


*--------------------------------------------------------------------*
FORM _obtenerclipboard CHANGING e_clip TYPE char255.

  DATA: lt_clipboard TYPE TABLE OF char255.

  cl_gui_frontend_services=>clipboard_import( IMPORTING data = lt_clipboard ).

  READ TABLE lt_clipboard INTO e_clip INDEX 1.
  CONDENSE e_clip.
  TRANSLATE e_clip TO UPPER CASE.

ENDFORM.


*--------------------------------------------------------------------*
FORM _asignaclipboard_executeahk USING i_data TYPE clike
                                           i_ahk  TYPE clike.
  DATA: lt_data TYPE TABLE OF char255.

  APPEND i_data TO lt_data.

  cl_gui_frontend_services=>clipboard_export(
    IMPORTING data = lt_data
    CHANGING rc = sy-windi ).

  cl_gui_frontend_services=>execute( document = i_ahk ).

ENDFORM.


*----------------------------------------------------------------------*
FORM obtenerempresa CHANGING es_empresa TYPE gty_empresa.

  DATA: lt_char    TYPE TABLE OF char40,
        lt_empresa TYPE TABLE OF gty_empresa.

  DATA: ls_empresa       LIKE LINE OF lt_empresa,
        ls_char          LIKE LINE OF lt_char,
        l_license_number TYPE string.

  APPEND '0020299975 acfarma' TO lt_char.
  APPEND '0020311006 aib'       TO lt_char.
  APPEND '0020729594 austral'   TO lt_char.
  APPEND '0020241712 beta'      TO lt_char.
  APPEND '0020181230 c2e2'      TO lt_char.
  APPEND '0020286661 calida'    TO lt_char.
  APPEND '0020397182 cew'       TO lt_char.
  APPEND '0020241712 exalmar'   TO lt_char.
  APPEND '0020310624 honda'     TO lt_char.
  APPEND '0020649145 ipesa'     TO lt_char.
  APPEND '0020557725 kmmp'      TO lt_char.
  APPEND '0020744072 medrock'   TO lt_char.
  APPEND '0020316164 modasa'    TO lt_char.
  APPEND '0020266731 molicop'   TO lt_char.
  APPEND '0020758614 lsa'       TO lt_char.
  APPEND '0020886783 pedregal'  TO lt_char.
  APPEND '0020879177 petramas'  TO lt_char.
  APPEND '0020886706 piramide'  TO lt_char.
  APPEND '0020895037 promelsa'  TO lt_char.

  LOOP AT lt_char INTO ls_char.
    ls_empresa-licencia = ls_char(10).
    ls_empresa-empresa  = ls_char+11.
    APPEND ls_empresa TO lt_empresa.
  ENDLOOP.


  "Licencia
  CALL FUNCTION 'SLIC_GET_LICENCE_NUMBER'
    IMPORTING
      license_number = l_license_number.

  l_license_number = l_license_number.


  "Valida
  READ TABLE lt_empresa INTO es_empresa WITH KEY licencia = l_license_number.
  IF sy-subrc <> 0.
    MESSAGE 'Licencia no registrado' TYPE 'E'.
  ENDIF.

ENDFORM.


*--------------------------------------------------------------------*
FORM _crearnombrearchivocompleto USING  i_ruta    TYPE clike
                                        i_empresa TYPE clike
                                        i_carpeta TYPE clike
                                        i_archivo TYPE clike
                                        i_extension TYPE clike
                                 CHANGING e_archivocompleto TYPE clike.

  DATA: l_carpeta_destino TYPE char255.

  "petramas_sd
  CONCATENATE i_empresa i_carpeta INTO l_carpeta_destino SEPARATED BY gc_underline.

  "D:\code_sql\petramas_sd\sd
  CONCATENATE i_ruta l_carpeta_destino i_archivo INTO e_archivocompleto SEPARATED BY gc_slash_unix.

  "D:\code_sql\petramas_sd\sd.sql
  CONCATENATE e_archivocompleto i_extension INTO e_archivocompleto.

ENDFORM.